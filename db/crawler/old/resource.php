<?php
//$id_arr = [38898921,38903420,38903421,38903442,38903501,38903508,38903529,38903542,38903543,38903593,38903640,38903643,38903653,38903664,38903691,38903700,38903720,38903726,38903728,38903773,38903801,38903804,38903810,38903817,38903821,38903828,38903830,38903856,38903877,38903902,38903909,38903910,38903923,38903938,38903975,38903984,38904001,38904005,38904021,38904038,38904077,38904079,38904108,38904123,38904133,38904147,38904160,38904199,38904238,38904239,38904268,38904274,38904298,38904311,38904331,38904341,38904342,38904344,38904346,38904386,38904397,38904415,38904456,38904524,38904531,38904641,38904644,38904651,38904653,38904675,38904723,38904726,38904758,38904796,38904802,38904812,38904844,38904860,38904861,38904863,38904871,38904872,38904873,38904877,38904878,38904879,38904881,38904882,38904892,38904895,38904904,38904919,38904929,38904986,38904988,38905020,38905021,38905025,38905034,38905051,38905059,38905118,38905123,38905124,38905126,38905131,38905159,38905161,38905165,38905174,38905176,38905233,38905234,38905285,38905291,38905348,38905354,38905389,38905421,38905425,38905455,38905477,38905482,38905491,38905515,38905534,38905535,38905536,38905607,38905609,38905626,38905770,38905774,38905776,38905777,38905796,38905801,38905833,38905835,38905841,38905856,38905867,38905875,38905909,38905944,38905953,38906123,38906136,38906205,38906238,38906240,38906298,38906300,38906333,38906368,38906530,38906556,38906574,38906590,38906592,38906593,38906596,38906602,38906603,38906615,38906630,38906652,38906653,38906654,38906656,38906663,38906665,38906691,38906703,38906709,38906732,38906733,38906775,38906776,38906880,38906895,38906904,38906945,38906948,38906963,38906995,38906998,38907032,38907042,38907044,38907054,38907083,38907092,38907103,38907108,38907169,38907182,38907202,38907209,38907242,38907245,38907269,38907272,38907275,39981848,40395917,48003700,49698889,51432403,52143061,55306188,55924501,57667891,59008096,59008117,59474138,61856905,65142962,66084518,66426291,67475901,67744055,68288865,68832155,68913948,68943226,69004347,69026112,69026270,69027174,69027234];
// id_arr for first round agencies from OAK
$id_arr = [38904327,38904364,38907109,38907159,51793857,38903629,38903654,38903969,38903970,38906267,38906808,53029262,38904212,38904215,38905099,38905101,55503688,55503688,69256199,56482150,38904660,38903637,69028981,38903875,38903915,38904009,38904279,38904398,38907314,38904804,42524498,55615041,38903824,38904866,38904868,38904883,38905154,38905773,38906995,38904479,38904931,38904932,56809622];
$results_arr = [];

foreach ($id_arr as $id) {
	$timestamp = date("Y-m-d H:i:s");
	ob_start();
	passthru("curl -sS 'https://na0apiv2.icarol.com/v2/Resource/Get/?id=".$id."&db=2376&clientAppContext=prd&culture=en' \
    -H 'authority: na0apiv2.icarol.com' \
    -H 'accept: application/json, text/plain, */*' \
    -H 'clientid: 2376' \
    -H 'authorization: Bearer c05ad953-b2cc-4a9c-9be1-7dd1f755f3d8' \
    -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36' \
    -H 'db: 2376' \
    -H 'content-type: application/json;charset=UTF-8' \
    -H 'origin: https://prd.icarol.com' \
    -H 'sec-fetch-site: same-site' \
    -H 'sec-fetch-mode: cors' \
    -H 'sec-fetch-dest: empty' \
    -H 'referer: https://prd.icarol.com/resourceview.html?id=".$id."&token=c05ad953-b2cc-4a9c-9be1-7dd1f755f3d8&cssMode=Publish&orgNum=2376&db=2376&culture=en' \
    -H 'accept-language: en-US,en;q=0.9' \
    --data-binary '{\"Token\":\"c05ad953-b2cc-4a9c-9be1-7dd1f755f3d8\",\"OrgNum\":\"2376\"}' \
    --compressed");
	$out = ob_get_clean();
	$res = json_decode($out, TRUE);
    if (isset($res["id"])) {
        unset($res["resource_info"]["language"]);
        unset($res["resource_info"]["custom_field_selection"]);
        unset($res["services"]);
        unset($res["service_at_locations"]);
        unset($res["locations"]);
        unset($res["service_area"]);
        unset($res["lanaguage"]);
        if (isset($res["contact"][0]) && isset($res["contact"][0])) $res["contact"] = $res["contact"][0];
        if (isset($res["physical_address"][0]) && isset($res["physical_address"][0])) $res["physical_address"] = $res["physical_address"][0];
        if (isset($res["postal_address"][0]) && isset($res["postal_address"][0])) $res["postal_address"] = $res["postal_address"][0];
        if (isset($res["phone"][0]) && isset($res["phone"][0])) $res["phone"] = $res["phone"][0];
        $res["last_scraped"] = gmdate("Y-m-d H:i:s", time());
        $results_arr[] = $res;
		echo "ID: ".$id."\n";
	} else {
		echo "ID: ".$id.": NO DATA!\n";
	}
	sleep(5);
}

file_put_contents("./data/resource_results.".gmdate("YmdHis", time()).".json", json_encode($results_arr));
echo "COMPLETE!\n";
